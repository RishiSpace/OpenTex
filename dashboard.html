<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OpenTex Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide-dev@latest"></script>
  <style>
    body { background:#000; color:#e0e0e0 }
    .bg-card { background:#111 }
    .border-divider { border-color:#333 }
    .hover\:bg-hover:hover { background:#222 }
    .hidden { display:none; }
  </style>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">OpenTex — Projects</h1>
      <div class="flex gap-2">
        <input id="new-project-name" placeholder="New project name" class="px-3 py-2 rounded bg-card border border-divider" />
        <button id="create-project-btn" class="px-4 py-2 bg-blue-600 rounded">Create</button>
        <button id="method-test-btn" class="px-4 py-2 bg-gray-700 rounded">Method Test</button>
      </div>
    </header>

    <section class="grid grid-cols-12 gap-6">
      <div class="col-span-12 md:col-span-7 lg:col-span-8 bg-card p-4 rounded border border-divider">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg">Projects</h2>
          <div class="text-sm text-muted">Select a project to open editor</div>
        </div>
        <div id="projects-list" class="space-y-2">
          Loading projects...
        </div>
      </div>

      <aside class="col-span-12 md:col-span-5 lg:col-span-4 bg-card p-4 rounded border border-divider">
        <h2 class="text-lg mb-2">Git Integration</h2>
        <div id="git-status" class="mb-3 text-sm text-muted">Loading git config...</div>

        <form id="git-config-form" class="space-y-2" enctype="multipart/form-data">
          <label class="block text-sm">
            Git Host (e.g., github.com)
            <input name="host" id="git-host" class="w-full mt-1 px-3 py-2 rounded bg-black border border-divider" />
          </label>
          <label class="block text-sm">
            Git Username (e.g., your-user)
            <input name="username" id="git-username" class="w-full mt-1 px-3 py-2 rounded bg-black border border-divider" />
          </label>
          <label class="block text-sm">
            Private SSH Key (id_rsa) <span class="text-xs text-muted">required</span>
            <input type="file" name="private_key" id="private-key" accept=".pem,.key" class="w-full mt-1" />
          </label>
          <label class="block text-sm">
            Public SSH Key (id_rsa.pub) <span class="text-xs text-muted">(optional)</span>
            <input type="file" name="public_key" id="public-key" accept=".pub" class="w-full mt-1" />
          </label>
          <div class="flex gap-2 pt-2">
            <button type="submit" class="px-4 py-2 bg-green-600 rounded">Save Git Config</button>
            <button id="test-push-sample" type="button" class="px-4 py-2 bg-slate-700 rounded">Test push (first project)</button>
          </div>
        </form>
        <div id="git-output" class="mt-3 p-2 bg-black rounded text-xs whitespace-pre-wrap hidden"></div>
      </aside>
    </section>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const projectsList = document.getElementById('projects-list');
    const gitStatus = document.getElementById('git-status');
    const gitForm = document.getElementById('git-config-form');
    const gitOutput = document.getElementById('git-output');
    const createBtn = document.getElementById('create-project-btn');
    const newProjectNameInput = document.getElementById('new-project-name');
    const testPushSample = document.getElementById('test-push-sample');
    const methodTestBtn = document.getElementById('method-test-btn');

    if (!projectsList || !gitStatus || !gitForm || !gitOutput || !createBtn || !newProjectNameInput || !testPushSample || !methodTestBtn) {
      console.error('Dashboard: missing DOM elements.');
      return;
    }

    async function parseResponseSafe(resp) {
      const ctype = resp.headers.get('content-type') || '';
      try {
        if (ctype.includes('application/json')) return await resp.json();
        const text = await resp.text();
        try { return JSON.parse(text); } catch(e) { return { nonJson: true, text }; }
      } catch (e) {
        return { nonJson: true, text: `Failed to read response: ${e.message}` };
      }
    }

    function showGitOutput(text) {
      gitOutput.textContent = text;
      gitOutput.classList.remove('hidden');
    }

    // Try POST delete first (safe behind proxies). If 404/405 or fails, try DELETE fallback.
    async function tryDeleteProject(name) {
      // 1) Try POST to explicit delete endpoint
      let resp = await fetch(`/api/projects/${encodeURIComponent(name)}/delete`, { method: 'POST' });
      if (resp.status >= 200 && resp.status < 300) return resp;
      // 2) Fallback to DELETE on canonical endpoint
      resp = await fetch(`/api/projects/${encodeURIComponent(name)}`, { method: 'DELETE' });
      return resp;
    }

    async function loadProjects() {
      projectsList.innerHTML = 'Loading...';
      try {
        const res = await fetch('/api/projects');
        const projects = await res.json().catch(() => []);
        projectsList.innerHTML = '';
        if (!projects || projects.length === 0) {
          projectsList.innerHTML = '<div class="text-muted p-3">No projects found.</div>';
          return;
        }
        for (const p of projects) {
          const card = document.createElement('div');
          card.className = 'p-3 bg-black rounded border border-divider flex items-center justify-between';
          const left = document.createElement('div');
          left.innerHTML = `<div class="font-medium">${p}</div><div class="text-xs text-muted">click Open to edit</div>`;
          const actions = document.createElement('div');
          actions.className = 'flex gap-2';

          const openBtn = document.createElement('button');
          openBtn.className = 'px-3 py-1 bg-slate-700 rounded text-sm';
          openBtn.textContent = 'Open';
          openBtn.addEventListener('click', () => {
            window.location.href = `/editor?project=${encodeURIComponent(p)}`;
          });

          const pushBtn = document.createElement('button');
          pushBtn.className = 'px-3 py-1 bg-emerald-600 rounded text-sm';
          pushBtn.textContent = 'Push';
          pushBtn.addEventListener('click', async () => {
            if (!confirm(`Push project '${p}' to remote repo named '${p}-tex'?`)) return;
            pushBtn.disabled = true;
            pushBtn.textContent = 'Pushing...';
            try {
              const resp = await fetch(`/api/projects/${encodeURIComponent(p)}/git_push`, { method: 'POST' });
              const data = await parseResponseSafe(resp);
              if (data && data.nonJson) {
                showGitOutput(data.text);
                alert('Push returned non-JSON response. See output for details.');
              } else {
                showGitOutput(JSON.stringify(data, null, 2));
                if (data.ok) alert('Push succeeded (see output).'); else alert('Push failed — check output for details.');
              }
            } catch (err) {
              showGitOutput(err.message);
              alert('Network error while pushing.');
            } finally {
              pushBtn.disabled = false;
              pushBtn.textContent = 'Push';
            }
          });

          const delBtn = document.createElement('button');
          delBtn.className = 'px-3 py-1 bg-red-600 rounded text-sm';
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', async () => {
            if (!confirm(`Delete project '${p}' and all its files? This cannot be undone.`)) return;
            delBtn.disabled = true;
            delBtn.textContent = 'Deleting...';
            try {
              const resp = await tryDeleteProject(p);
              const data = await parseResponseSafe(resp);
              if (resp.status >= 200 && resp.status < 300) {
                // only remove after server confirms
                card.remove();
              } else {
                if (data && data.nonJson) {
                  showGitOutput(data.text);
                  alert('Delete failed — server returned non-JSON. See output for details.');
                } else {
                  alert('Delete failed: ' + (data.error || JSON.stringify(data)));
                }
                delBtn.disabled = false;
                delBtn.textContent = 'Delete';
              }
            } catch (err) {
              alert('Network error: ' + err.message);
              delBtn.disabled = false;
              delBtn.textContent = 'Delete';
            }
          });

          actions.appendChild(openBtn);
          actions.appendChild(pushBtn);
          actions.appendChild(delBtn);

          card.appendChild(left);
          card.appendChild(actions);
          projectsList.appendChild(card);
        }
      } catch (err) {
        projectsList.innerHTML = '<div class="text-red-500 p-3">Failed to load projects.</div>';
      }
    }

    // Method Test button — calls /api/test_method and shows the received method
    methodTestBtn.addEventListener('click', async () => {
      try {
        const resp = await fetch('/api/test_method', { method: 'DELETE' });
        const data = await resp.json().catch(() => ({ nonJson: true }));
        showGitOutput(JSON.stringify(data, null, 2));
        alert('Check the "Method Test" output panel to see which method the server received.');
      } catch (err) {
        showGitOutput(err.message);
        alert('Network error while testing method.');
      }
    });

    async function loadGitConfig() {
      gitStatus.textContent = 'Loading git config...';
      try {
        const res = await fetch('/api/git/config');
        const data = await parseResponseSafe(res);
        if (data && data.configured) {
          gitStatus.innerHTML = `<div class="text-sm">Configured for <strong>${data.username}@${data.host}</strong></div>`;
          document.getElementById('git-host').value = data.host || '';
          document.getElementById('git-username').value = data.username || '';
        } else if (data && data.nonJson) {
          gitStatus.innerHTML = `<div class="text-sm text-red-500">Git config response not JSON. See output.</div>`;
          showGitOutput(data.text);
        } else {
          gitStatus.innerHTML = '<div class="text-sm text-muted">Not configured</div>';
        }
      } catch (err) {
        gitStatus.innerHTML = '<div class="text-sm text-red-500">Failed to load git config</div>';
      }
    }

    gitForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(gitForm);
      try {
        const resp = await fetch('/api/git/config', { method: 'POST', body: form });
        const data = await parseResponseSafe(resp);
        if (resp.ok) {
          alert('Git config saved.');
          loadGitConfig();
        } else {
          if (data && data.nonJson) {
            showGitOutput(data.text);
            alert('Failed to save git config — server returned non-JSON. See output.');
          } else {
            alert('Failed to save git config: ' + (data.error || JSON.stringify(data)));
          }
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    });

    createBtn.addEventListener('click', async () => {
      const name = newProjectNameInput.value.trim();
      if (!name) return alert('Enter project name');
      createBtn.disabled = true;
      try {
        const resp = await fetch('/api/projects', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ name })
        });
        const data = await parseResponseSafe(resp);
        if (resp.ok) {
          newProjectNameInput.value = '';
          loadProjects();
        } else {
          if (data && data.nonJson) {
            showGitOutput(data.text);
            alert('Create failed — server returned non-JSON. See output.');
          } else {
            alert('Create failed: ' + (data.error || JSON.stringify(data)));
          }
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      } finally {
        createBtn.disabled = false;
      }
    });

    testPushSample.addEventListener('click', async () => {
      try {
        const res = await fetch('/api/projects');
        const projects = await res.json().catch(() => []);
        if (!projects.length) return alert('No projects to test push on.');
        const first = projects[0];
        if (!confirm(`Attempt push for '${first}'?`)) return;
        const resp = await fetch(`/api/projects/${encodeURIComponent(first)}/git_push`, { method: 'POST' });
        const data = await parseResponseSafe(resp);
        if (data && data.nonJson) {
          showGitOutput(data.text);
          alert('Push returned non-JSON response. See output for details.');
        } else {
          showGitOutput(JSON.stringify(data, null, 2));
          if (data.ok) alert('Push succeeded (see output).'); else alert('Push failed — see output.');
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    });

    // initial load
    loadProjects();
    loadGitConfig();
  });
  </script>
</body>
</html>
